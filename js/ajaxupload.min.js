// 1.0.2
/*
Version History:
  1.0.2 (2015-12-06)
    1) Now keeps track of items being uploader and only refreshes parent window and closes when
       all pending files have been uploaded
  1.0.1 (2015-11-29)
    1) Tweak to error message when only one file type is valid
  1.0.0 (2015-11-29)
    1) Initial release
*/
jl_sessions=[],$(function(){function e(e){return"number"!=typeof e?"":e>=1073741824?(e/1073741824).toFixed(2)+" GB":e>=1048576?(e/1048576).toFixed(2)+" MB":(e/1024).toFixed(2)+" KB"}var t=$("#upload ul");$("#drop a").click(function(){$(this).parent().find("input").click()}),$("#upload").fileupload({dropZone:$("#drop"),add:function(n,i){i.maxbytes=parseInt($("#drop").attr("data-max-bytes")),i.filetypes=$("#drop").attr("data-file-types").split(","),i.ext=i.files[0].name.split(".").pop();var s=$('<li class="working"><input type="text" value="0" data-width="48" data-height="48" data-fgColor="#0788a5" data-readOnly="1" data-bgColor="#3e4043" /><p></p><span></span></li>'),o=!0;if(s.find("p").text(i.files[0].name).append("<br /><i>"+e(i.files[0].size)+(i.files[0].size>i.maxbytes||-1===jQuery.inArray(i.ext,i.filetypes)?"ERROR:":"")+(-1===jQuery.inArray(i.ext,i.filetypes)?" File must be "+(i.filetypes.length>1?"one of ":"of type ")+i.filetypes.join(", ")+" &nbsp; ":"")+(i.files[0].size>i.maxbytes?" Max size is "+e(i.maxbytes):"")+"</i>"),i.context=s.appendTo(t),s.find("input").knob(),s.find("span").click(function(){s.fadeOut(function(){s.remove()})}),i.files[0].size>i.maxbytes&&(o=!1),-1===jQuery.inArray(i.ext,i.filetypes)&&(o=!1),o){jl_sessions.push(i.files[0].name);i.submit().success(function(e,t,n){var s=JSON.parse(e),o=s.status;"error"==o&&(i.context.find("p").append("<i>"+s.message+"</i>"),i.context.addClass("error"))})}},progress:function(e,t){var n=parseInt(t.loaded/t.total*100,10);if(t.context.find("input").val(n).change(),100==n){t.context.removeClass("working");for(var i=jl_sessions.length-1;i>=0;i--)jl_sessions[i]===t.files[0].name&&jl_sessions.splice(i,1);0===jl_sessions.length&&window.setTimeout(function(){window.opener&&window.opener.geid("form")?(t.context.fadeOut("slow"),window.opener.geid("form").submit(),window.close()):window.parent&&window.parent.geid("form")&&(t.context.fadeOut("slow"),window.parent.geid("form").submit())},1e3)}},fail:function(e,t){t.context.addClass("error"),t.context.removeClass("working"),t.context.find("input").val(0).change(),alert(JSON.parse(t.jqXHR.responseText).message)}}),$(document).on("drop dragover",function(e){e.preventDefault()})});