// 1.0.1
$(function(){function e(e){return"number"!=typeof e?"":e>=1073741824?(e/1073741824).toFixed(2)+" GB":e>=1048576?(e/1048576).toFixed(2)+" MB":(e/1024).toFixed(2)+" KB"}var t=$("#upload ul");$("#drop a").click(function(){$(this).parent().find("input").click()}),$("#upload").fileupload({dropZone:$("#drop"),add:function(n,i){i.maxbytes=parseInt($("#drop").attr("data-max-bytes")),i.filetypes=$("#drop").attr("data-file-types").split(","),i.ext=i.files[0].name.split(".").pop();var o=$('<li class="working"><input type="text" value="0" data-width="48" data-height="48" data-fgColor="#0788a5" data-readOnly="1" data-bgColor="#3e4043" /><p></p><span></span></li>'),a=!0;if(o.find("p").text(i.files[0].name).append("<br /><i>"+e(i.files[0].size)+(i.files[0].size>i.maxbytes||-1===jQuery.inArray(i.ext,i.filetypes)?"ERROR:":"")+(-1===jQuery.inArray(i.ext,i.filetypes)?" File must be "+(i.filetypes.length>1?"one of ":"of type ")+i.filetypes.join(", ")+" &nbsp; ":"")+(i.files[0].size>i.maxbytes?" Max size is "+e(i.maxbytes):"")+"</i>"),i.context=o.appendTo(t),o.find("input").knob(),o.find("span").click(function(){o.fadeOut(function(){o.remove()})}),i.files[0].size>i.maxbytes&&(a=!1),-1===jQuery.inArray(i.ext,i.filetypes)&&(a=!1),a){i.submit().success(function(e,t,n){var o=JSON.parse(e),a=o.status;"error"==a&&(i.context.find("p").append("<i>"+o.message+"</i>"),i.context.addClass("error"))})}},progress:function(e,t){var n=parseInt(t.loaded/t.total*100,10);t.context.find("input").val(n).change(),100==n&&(t.context.removeClass("working"),window.setTimeout(function(){window.opener&&window.opener.geid("form")?(t.context.fadeOut("slow"),window.opener.geid("form").submit(),window.close()):window.parent&&window.parent.geid("form")&&(t.context.fadeOut("slow"),window.parent.geid("form").submit())},1e3))},fail:function(e,t){t.context.addClass("error"),t.context.removeClass("working"),t.context.find("input").val(0).change(),alert(JSON.parse(t.jqXHR.responseText).message)}}),$(document).on("drop dragover",function(e){e.preventDefault()})});